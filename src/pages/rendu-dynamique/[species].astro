---
import Layout from "../../layouts/Layout.astro";
import * as Plot from "@observablehq/plot";
import penguins from "../../assets/penguins.json";

export async function getStaticPaths() {
    const species = [...new Set(penguins.map((penguin) => penguin.species))];

    return species.map((specie) => ({
        params: {
            species: specie.toLowerCase(),
        },
        props: {
            specieOriginal: specie,
            penguins: penguins.filter((p) => p.species === specie),
        },
    }));
}

const { species } = Astro.params;
const { specieOriginal, penguins: filteredPenguins } = Astro.props;

const stats = {
    count: filteredPenguins.length,
    avgCulmenLength: (
        filteredPenguins.reduce(
            (sum, p) => sum + (p.culmen_length_mm || 0),
            0,
        ) / filteredPenguins.length
    ).toFixed(1),
    avgCulmenDepth: (
        filteredPenguins.reduce((sum, p) => sum + (p.culmen_depth_mm || 0), 0) /
        filteredPenguins.length
    ).toFixed(1),
};
---

<Layout>
    <div class="m-5">
        <div class="mb-6">
            <a class="text-blue-900 hover:underline" href="/rendu-dynamique"
                >Retour à l'index</a
            >
            <h1 class="text-3xl my-4">Espèce : {specieOriginal}</h1>
        </div>

        <div class="bg-blue-50 p-4 rounded-lg mb-6">
            <h2 class="text-xl font-semibold mb-2">Statistiques</h2>
            <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                    <p class="text-2xl font-bold text-blue-600">
                        {stats.count}
                    </p>
                    <p class="text-sm text-gray-600">Individus</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-blue-600">
                        {stats.avgCulmenLength}
                    </p>
                    <p class="text-sm text-gray-600">Long. moyenne (mm)</p>
                </div>
                <div>
                    <p class="text-2xl font-bold text-blue-600">
                        {stats.avgCulmenDepth}
                    </p>
                    <p class="text-sm text-gray-600">Prof. moyenne (mm)</p>
                </div>
            </div>
        </div>

        <div class="border rounded-lg p-4">
            <h2 class="text-xl font-semibold mb-4">
                Distribution culmen - {specieOriginal}
            </h2>
            <div
                id="plot-container"
                data-penguins={JSON.stringify(filteredPenguins)}
                data-species={specieOriginal}
            >
            </div>
        </div>

        <script>
            import * as Plot from "@observablehq/plot";

            const container = document.querySelector("#plot-container");
            const penguins = JSON.parse(container.dataset.penguins);
            const species = container.dataset.species;

            const plot = Plot.plot({
                marks: [
                    Plot.dot(penguins, {
                        x: "culmen_length_mm",
                        y: "culmen_depth_mm",
                        stroke: "species",
                    }),
                ],
            });

            container.append(plot);
        </script>
    </div>
</Layout>
