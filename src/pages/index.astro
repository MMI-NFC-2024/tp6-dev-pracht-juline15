---
import Layout from "../layouts/Layout.astro";
import * as Plot from "@observablehq/plot";
import penguins from "../assets/penguins.json";

const species = [...new Set(penguins.map((penguin) => penguin.species))];
---

<Layout>
  <nav class="bg-pink-800 shadow-lg sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-6">
      <div class="flex items-center justify-between h-16">
        <h1 class="text-xl font-semibold text-white">Penguins</h1>
        <div class="flex space-x-4">
          <a
            href="/"
            class="bg-white/20 text-white px-4 py-2 rounded-lg hover:bg-white/30"
          >
            Graphique
          </a>
          <a
            href="/rendu-dynamique"
            class="bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800"
          >
            Rendu dynamique
          </a>
          <a
            href="/rendu-statique"
            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"
          >
            Rendu statique
          </a>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-6xl mx-auto px-6 py-8">
    <section id="interactive" class="mb-16">
      <h2 class="text-2xl font-bold mb-6">Graphique</h2>

      <div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
        <div class="mb-6">
          <label
            for="species"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Choisissez une espèce :
          </label>
          <select
            name="species"
            id="species"
            class="border border-gray-300 rounded-lg px-4 py-2 w-64 bg-white"
          >
            <option value="">Toutes les espèces</option>
            {species.map((specie) => <option value={specie}>{specie}</option>)}
          </select>
        </div>

        <div
          id="myplot"
          data-penguins={JSON.stringify(penguins)}
          data-species={JSON.stringify(species)}
        >
        </div>
      </div>
    </section>
  </div>

  <script>
    import * as Plot from "@observablehq/plot";

    const div = document.querySelector("#myplot");
    const selectSpecies = document.querySelector("#species");
    const tabs = document.querySelectorAll(".tab");
    const penguins = JSON.parse(div.dataset.penguins);
    const species = JSON.parse(div.dataset.species);

    function renderPlot() {
      const selectedSpecies = selectSpecies.value;

      const data = selectedSpecies
        ? penguins.filter((p) => p.species === selectedSpecies)
        : penguins;

      div.innerHTML = "";

      const plot = Plot.plot({
        title: selectedSpecies
          ? `Espèce : ${selectedSpecies}`
          : "Toutes les espèces",
        marks: [
          Plot.dot(data, {
            x: "culmen_length_mm",
            y: "culmen_depth_mm",
            stroke: "species",
          }),
        ],
      });

      div.append(plot);
      updateTabs(selectedSpecies);
    }

    function updateTabs(selectedSpecies) {
      tabs.forEach((tab) => {
        tab.classList.remove("tab-active");
        if (tab.dataset.species === selectedSpecies) {
          tab.classList.add("tab-active");
        }
      });
    }

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        selectSpecies.value = tab.dataset.species;
        renderPlot();
      });
    });

    selectSpecies.addEventListener("change", renderPlot);
    renderPlot();
  </script>
</Layout>
